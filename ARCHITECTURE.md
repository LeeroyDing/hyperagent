# Hyperagent Architecture

Hyperagent is a high-agency autonomous AI assistant built in Go. It leverages the Gemini 1.5 Flash model for reasoning and the Model Context Protocol (MCP) for tool extensibility.

## System Overview

The system follows a classic agentic loop: **Observe -> Think -> Act -> Observe**.

### Core Components

1.  **Agent Loop (`internal/agent`)**: The central orchestrator that manages state, interacts with the LLM, and dispatches tool calls.
2.  **Gemini Client (`internal/gemini`)**: Handles communication with the Google Gemini API, including exponential backoff for reliability and embedding generation.
3.  **Memory System (`internal/memory`)**: A local-first vector database using `chromem-go`. It stores and retrieves relevant context using embeddings generated by Gemini.
4.  **MCP Manager (`internal/mcp`)**: Dynamically discovers and invokes tools from external MCP servers via standard I/O.
5.  **Shell Executor (`internal/executor`)**: Executes host shell commands with a security allowlist.
6.  **History Manager (`internal/history`)**: Persists conversation history in a JSONL format for session continuity.
7.  **Token Manager (`internal/token`)**: Counts tokens and prunes context to stay within model limits.

## Data Flow

1.  **Initialization**: The CLI (Cobra) parses flags, loads the YAML config, and initializes all internal components.
2.  **Context Retrieval**: At the start of each loop, the agent queries the Memory system for relevant past information based on the current prompt.
3.  **Reasoning**: The agent sends the system prompt, conversation history, relevant context, and available tools to Gemini.
4.  **Action Parsing**: The LLM's JSON response is parsed to identify the intended tool and arguments.
5.  **Execution**: 
    - If it's a shell command or MCP call, the agent checks for Interactive Mode confirmation.
    - The tool is executed, and the output is captured.
6.  **Persistence**: The action and its result are saved to the history file.
7.  **Loop**: The tool output is appended to the prompt for the next iteration until a final response is generated.

## Security Model

- **Interactive Mode**: High-risk actions (shell/MCP) require manual user confirmation.
- **Command Allowlist**: Only permitted shell commands can be executed.
- **Local-First**: Vector memory and session history are stored locally on the host.

## Deployment

- **Docker**: A multi-stage Dockerfile provides a minimal Alpine-based image.
- **Releases**: GoReleaser handles cross-platform builds for Linux, macOS, and Windows.
