<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperagent Web</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: #e5e5e5; }
        .sidebar { width: 260px; background-color: #202123; }
        .chat-area { flex: 1; background-color: #343541; }
        .message-user { background-color: #343541; }
        .message-assistant { background-color: #444654; }
        .config-editor { background-color: #2d2d2d; color: #d4d4d4; font-family: monospace; }
        .memory-card { background-color: #2d2d2d; border: 1px solid #3e3e3e; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [sessions, setSessions] = useState([]);
            const [currentSession, setCurrentSession] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [view, setView] = useState('chat'); // 'chat', 'settings', or 'memory'
            const [config, setConfig] = useState('');
            const [saveStatus, setSaveStatus] = useState('');
            const [memories, setMemories] = useState([]);
            const [memoryQuery, setMemoryQuery] = useState('');

            useEffect(() => {
                fetchSessions();
            }, []);

            useEffect(() => {
                if (currentSession) {
                    fetchMessages(currentSession);
                    setView('chat');
                }
            }, [currentSession]);

            const fetchSessions = async () => {
                try {
                    const res = await fetch('/api/sessions');
                    const data = await res.json();
                    setSessions(Array.isArray(data) ? data : []);
                } catch (e) { console.error(e); }
            };

            const fetchMessages = async (id) => {
                try {
                    const res = await fetch(`/api/sessions/${id}/messages`);
                    const data = await res.json();
                    setMessages(Array.isArray(data) ? data : []);
                } catch (e) { console.error(e); }
            };

            const fetchConfig = async () => {
                try {
                    const res = await fetch('/api/config');
                    const data = await res.text();
                    setConfig(data);
                    setView('settings');
                } catch (e) { console.error(e); }
            };

            const fetchMemories = async (query = '') => {
                try {
                    const res = await fetch(`/api/memory?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    setMemories(Array.isArray(data) ? data : []);
                    setView('memory');
                } catch (e) { console.error(e); }
            };

            const deleteMemory = async (id) => {
                if (!confirm('Are you sure you want to delete this memory?')) return;
                try {
                    const res = await fetch(`/api/memory/${id}`, { method: 'DELETE' });
                    if (res.ok) fetchMemories(memoryQuery);
                } catch (e) { console.error(e); }
            };

            const saveConfig = async () => {
                setSaveStatus('Saving...');
                try {
                    const res = await fetch('/api/config', {
                        method: 'POST',
                        body: config
                    });
                    if (res.ok) {
                        setSaveStatus('Saved successfully!');
                        setTimeout(() => setSaveStatus(''), 3000);
                    } else {
                        setSaveStatus('Error saving config');
                    }
                } catch (e) {
                    setSaveStatus('Error saving config');
                    console.error(e);
                }
            };

            const createSession = async () => {
                try {
                    const res = await fetch('/api/sessions', { method: 'POST' });
                    const data = await res.json();
                    setCurrentSession(data.id);
                    fetchSessions();
                } catch (e) { console.error(e); }
            };

            const sendMessage = async () => {
                if (!input.trim() || !currentSession) return;
                const userMsg = { role: 'user', content: input };
                setMessages([...messages, userMsg]);
                const text = input;
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch(`/api/sessions/${currentSession}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: text })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, data]);
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex h-screen">
                    {/* Sidebar */}
                    <div className="sidebar flex flex-col p-2">
                        <button
                            onClick={createSession}
                            className="border border-white/20 rounded p-3 mb-2 hover:bg-white/10 transition-colors text-left"
                        >
                            + New Chat
                        </button>
                        <div className="flex-1 overflow-y-auto">
                            {sessions.map(s => (
                                <div
                                    key={s.id}
                                    onClick={() => setCurrentSession(s.id)}
                                    className={`p-3 rounded cursor-pointer hover:bg-white/5 truncate ${currentSession === s.id && view === 'chat' ? 'bg-white/10' : ''}`}
                                >
                                    {s.name || s.id}
                                </div>
                            ))}
                        </div>
                        <button
                            onClick={() => fetchMemories()}
                            className={`p-3 rounded hover:bg-white/10 transition-colors text-left mt-2 ${view === 'memory' ? 'bg-white/10' : ''}`}
                        >
                            üß† Memory
                        </button>
                        <button
                            onClick={fetchConfig}
                            className={`p-3 rounded hover:bg-white/10 transition-colors text-left mt-2 ${view === 'settings' ? 'bg-white/10' : ''}`}
                        >
                            ‚öôÔ∏è Settings
                        </button>
                    </div>

                    {/* Main Area */}
                    <div className="chat-area flex flex-col">
                        {view === 'chat' ? (
                            <>
                                <div className="flex-1 overflow-y-auto">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`p-6 ${m.role === 'assistant' ? 'message-assistant' : 'message-user'}`}>
                                            <div className="max-w-3xl mx-auto flex gap-4">
                                                <div className="font-bold w-20">{m.role === 'assistant' ? 'ü§ñ' : 'üë§'}</div>
                                                <div className="whitespace-pre-wrap">{m.content}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {loading && (
                                        <div className="p-6 message-assistant">
                                            <div className="max-w-3xl mx-auto flex gap-4">
                                                <div className="font-bold w-20">ü§ñ</div>
                                                <div className="animate-pulse">Thinking...</div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Input Area */}
                                <div className="p-6 border-t border-white/10">
                                    <div className="max-w-3xl mx-auto relative">
                                        <textarea
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendMessage())}
                                            placeholder="Type a message..."
                                            className="w-full bg-transparent border border-white/20 rounded-lg p-4 pr-12 focus:outline-none focus:ring-1 focus:ring-white/40 resize-none"
                                            rows="1"
                                        />
                                        <button
                                            onClick={sendMessage}
                                            className="absolute right-3 bottom-3 p-1 rounded hover:bg-white/10"
                                        >
                                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </>
                        ) : view === 'settings' ? (
                            <div className="flex-1 flex flex-col p-8">
                                <div className="max-w-4xl w-full mx-auto flex-1 flex flex-col">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold">Configuration Editor</h2>
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm text-gray-400">{saveStatus}</span>
                                            <button
                                                onClick={saveConfig}
                                                className="bg-white text-black px-4 py-2 rounded font-bold hover:bg-gray-200 transition-colors"
                                            >
                                                Save Changes
                                            </button>
                                        </div>
                                    </div>
                                    <textarea
                                        value={config}
                                        onChange={(e) => setConfig(e.target.value)}
                                        className="flex-1 config-editor p-4 rounded-lg focus:outline-none focus:ring-1 focus:ring-white/40 resize-none"
                                        spellCheck="false"
                                    />
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col p-8 overflow-y-auto">
                                <div className="max-w-4xl w-full mx-auto">
                                    <h2 className="text-2xl font-bold mb-6">Long-Term Memory</h2>
                                    <div className="mb-8">
                                        <input
                                            type="text"
                                            value={memoryQuery}
                                            onChange={(e) => setMemoryQuery(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && fetchMemories(memoryQuery)}
                                            placeholder="Search memories..."
                                            className="w-full bg-transparent border border-white/20 rounded-lg p-4 focus:outline-none focus:ring-1 focus:ring-white/40"
                                        />
                                    </div>
                                    <div className="grid gap-4">
                                        {memories.map(m => (
                                            <div key={m.id} className="memory-card p-4 rounded-lg flex justify-between items-start gap-4">
                                                <div className="flex-1">
                                                    <div className="text-xs text-gray-500 mb-1 font-mono">{m.id}</div>
                                                    <div className="whitespace-pre-wrap">{m.content}</div>
                                                </div>
                                                <button
                                                    onClick={() => deleteMemory(m.id)}
                                                    className="text-red-500 hover:text-red-400 p-1"
                                                    title="Delete memory"
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                        ))}
                                        {memories.length === 0 && (
                                            <div className="text-center text-gray-500 py-12">No memories found.</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
